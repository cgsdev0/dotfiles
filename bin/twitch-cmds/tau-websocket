#!/bin/zsh

cd "${0%/*}"

CHAN="badcop_"
source ./fish-cmds


reqreader() {
  while IFS= read -r line; do
      # echo "$line" | jq
      eventType=$(echo "$line" | jq -r '."event_type"');
      event_key=$(echo "$line" | jq -r '."event"');
      if [[ "$event_key" != "keep_alive" ]]; then
        echo "Incoming $eventType event..."
        case $eventType in
            "channel-channel_points_custom_reward_redemption-add")

                who=$(echo "$line" | jq -r '.event_data.user_name');
                reward=$(echo "$line" | jq -r '.event_data.reward.title');
                echo "$who redeemed '$reward'!"
                case $reward in
                    "Good Rod")
                        name=$who
                        give_rod good 30 1>&2
                        ;;
                    "Super Rod")
                        name=$who
                        give_rod super 30 1>&2
                        ;;
                    "NULL Rod")
                        name=$who
                        give_rod null 1 1>&2
                        ;;
                    "Hotdog")
                        hotdog &
                        (sleep 120; hotdog not) &
                        ;;
                esac
                ;;
            "channel-subscription-gift")
                is_anon=$(echo "$line" | jq -r '.event_data.is_anonymous');
                who=$(echo "$line" | jq -r '.event_data.user_name');
                if [[ "$is_anon" == "true" ]]; then
                    who="An Anonymous Gifter"
                fi
                total=$(echo "$line" | jq -r '.event_data.total');
                send-twitch-msg "$who is gifting $total subs to the channel!"
                sleep 0.5
                ;;
            "channel-subscribe")
                who=$(echo "$line" | jq -r '.event_data.user_name');
                is_gift=$(echo "$line" | jq -r '.event_data.is_gift');
                if [[ "$is_gift" == "true" ]]; then
                    send-twitch-msg "$who just received a gift sub! :D"
                else
                    send-twitch-msg "$who just subscribed! :D"
                fi
                rainbow-lights
                ;;
            "channel-follow")
                who=$(echo "$line" | jq -r '.event_data.user_name');
                send-twitch-msg "@$who just followed! :)"
                flash-lights
                ;;
            "channel-raid")
                who=$(echo "$line" | jq -r '.event_data.from_broadcaster_user_name');
                viewers=$(echo "$line" | jq -r '.event_data.viewers');
                send-twitch-msg "@$who just raided with $viewers viewers! :O"
                flash-lights
                ;;
              *)
                echo "unhandled $eventType event happened";
                echo "$line" | jq;
                ;;
        esac
      fi
  done;
  exit 0;
}

authenticate() {
    echo '{"token":"'$(cat ~/.tau_token)'"}'
    sleep infinity
}

set -o pipefail;
while true; do
  (authenticate) \
      | websocat -E wss://tau.cgs.dev/ws/twitch-events/ --ping-interval 10 --ping-timeout 15 \
      | reqreader
  FAILED=$?
  echo "$FAILED"
  if [[ "$FAILED" -ge 130 ]]; then
    exit 0
  fi
  echo "IT CRASHED, RESTARTING"
done
