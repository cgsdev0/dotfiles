#!/usr/bin/env bash

cd "${0%/*}"

CHAN="badcop_"

function reqreader() {
  while IFS= read -r line; do
      event_type="$(echo "$line" | jq -r '."event_type"')"
      event_key=$(echo "$line" | jq -r '."event"')
      if [[ "$event_key" != "keep_alive" ]]; then
        case $event_type in
            "channel-channel_points_custom_reward_redemption-add")

                who=$(echo "$line" | jq -r '.event_data.user_name');
                reward=$(echo "$line" | jq -r '.event_data.reward.title');
                echo "$who redeemed '$reward'!"
                case $reward in
                    "Hotdog")
                        hotdog &
                        (sleep 30; hotdog not) &
                        ;;
                    "Sand")
                        popup-queue 'experiment sand' &
                        ;;
                    "Random Effect")
                        effect=$(shuf -n1 ~/.random-effects)
                        echo "chosen effect: '$effect'"
                        popup-queue "experiment \"$effect\"" &
                        ;;
                    "CHOO CHOO")
                        # sfx train
                        popup-queue '</dev/null popup -a -B -h 100% -w 100% -E /usr/games/sl' &
                        ;;
                esac
                ;;
            "channel-subscription-gift")
            #     is_anon=$(echo "$line" | jq -r '.event_data.is_anonymous');
            #     who=$(echo "$line" | jq -r '.event_data.user_name');
            #     if [[ "$is_anon" == "true" ]]; then
            #         who="An Anonymous Gifter"
            #     fi
            #     total=$(echo "$line" | jq -r '.event_data.total');
            #     send-twitch-msg "$who is gifting $total subs to the channel!"
            #     sleep 0.5
                ;;
            "channel-subscribe")
            #     who=$(echo "$line" | jq -r '.event_data.user_name');
            #     is_gift=$(echo "$line" | jq -r '.event_data.is_gift');
            #     if [[ "$is_gift" == "true" ]]; then
            #         send-twitch-msg "$who just received a gift sub! :D"
            #     else
            #         send-twitch-msg "$who just subscribed! :D"
            #     fi
                # rainbow-lights
                ;;
            "channel-follow")
                # who=$(echo "$line" | jq -r '.event_data.user_name');
                # send-twitch-msg "@$who just followed! :)"
                # flash-lights
                ;;
            "channel-raid")
                who=$(echo "$line" | jq -r '.event_data.from_broadcaster_user_name');
                viewers=$(echo "$line" | jq -r '.event_data.viewers');
                # send-twitch-msg "@$who just raided with $viewers viewers! :O"
                # flash-lights
                ;;
        esac
      fi
  done
}

set -o pipefail;
while true; do
      sleep infinity \
          | websocat \
            -E 'wss://tau.cgs.dev/ws/twitch-events/' \
            --ping-interval 10 \
            --ping-timeout 15 \
          | reqreader
  FAILED=$?
  echo "$FAILED"
  if [[ "$FAILED" -ge 130 ]]; then
    echo gg
    exit 0
  fi
  echo "IT CRASHED, RESTARTING"
done
