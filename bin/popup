#!/usr/bin/env bash

LOCK=/tmp/tmux-popups-lock
# glitchcat ~/.current_cow --duration infinite --glitchness 30 --amount 30


# parse flags
while true; do
  case "$1" in
    -c|--client) CLIENT=$2; shift 2 ;;
    -w|--width)  WIDTH=$2;  shift 2 ;;
    -h|--height) HEIGHT=$2; shift 2 ;;
    -a|--all) all=1; shift ;;
    *) break ;;
  esac
done

function decolor() {
  if [[ "$1" == "force" ]]; then
    sed 's/\x1B\[[0-9;]\{1,\}[A-Za-z]//g'
  elif [[ "$EFFECT" == *"termsand"* ]]; then
    cat
  elif [[ -n "$EFFECT" ]]; then
    sed 's/\x1B\[[0-9;]\{1,\}[A-Za-z]//g'
  else
    cat
  fi
}

if [[ -z "$CLIENT" ]]; then
  if [[ -z "$all" ]]; then
    CLIENTS=$(tmux -L outer display -p '#{client_name}')
  else
    CLIENTS=$(tmux -L outer list-clients -F '#{client_name}')
  fi
else
  CLIENTS="$CLIENT"
fi

# if we're not reading from stdin
if [[ ! -p /dev/stdin ]]; then
  for CLIENT in $CLIENTS; do
    flock ${LOCK}${CLIENT//\//.} /bin/sh -c "tmux -L outer display-popup -c $CLIENT $*" &
  done
  wait
  exit 0
fi

TMP="$(mktemp)"
trap "rm $TMP" EXIT
height_computed=1
width_computed=10
decolor > "$TMP"
while IFS= read -r line; do
  if [[ ${#line} -gt $width_computed ]]; then
    width_computed=${#line}
  fi
  ((height_computed++))
done < <(decolor force < "$TMP")
((height_computed+=2))
((width_computed+=2))

for CLIENT in $CLIENTS; do
  max=$(tmux -L outer display -c $CLIENT -p '#{window_width} #{window_height}')
  read max_w max_h <<< "$max"
  ((max_h+=1))
  if [[ $height_computed -gt $max_h ]]; then
    height_computed=$max_h
  fi
  if [[ $width_computed -gt $max_w ]]; then
    width_computed=$max_w
  fi
  WIDTH=${WIDTH:-$width_computed}
  HEIGHT=${HEIGHT:-$height_computed}
  EFFECT="${EFFECT:-; tput civis}"
  flock $LOCK${CLIENT//\//.} /bin/sh -c "cd $PWD; tmux -L outer display-popup -c $CLIENT -w $WIDTH -h $HEIGHT $* 'tput cvvis; cd $PWD; cat \"$TMP\" $EFFECT'" &
done
wait
