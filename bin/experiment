#!/usr/bin/env bash

# for whatever reason, my outer tmux's PATH is messed up
# to compensate, we will do relative paths i guess
cd "${0%/*}"

# parse flags
while true; do
  case "$1" in
    -a|--all) all=1; shift ;;
    *) break ;;
  esac
done

case "$1" in
  "")
    echo "please specify an effect" 1>&2
    exit 1
    ;;
  debug)
    export EFFECT="| termsand --list-colors; sleep infinity"
    ;;
  snow)
    export EXTRA_ARGS="-E"
    export EFFECT="| termsand -c 2153144201 -b -d down snow --cycles 0"
    ;;
  silly)
    export EXTRA_ARGS="-E"
    export EFFECT="| termsand -c 208 -b -d down snow --cycles 0 --ms 16 -e tilt-shift"
    ;;
  sand)
    export EXTRA_ARGS="-E"
    export EFFECT="| termsand -c 2153999782 -b --bg=2151573719 --bg=3 --bg=2150449014 --bg=2164233836"
    ;;
  tilt)
    export EXTRA_ARGS="-E"
    export EFFECT="| termsand -c 2153999782 -b --bg=2151573719 --bg=3 --bg=2150449014 --bg=2164233836 --cycles 0 --ms 10 -e tilt-shift"
    ;;
  blender)
    export EXTRA_ARGS="-E"
    export EFFECT="| termsand -c 2153999782 -b --bg=2151573719 --bg=3 --bg=2150449014 --bg=2164233836 --cycles 0 --ms 6 -e blender"
    ;;
  # glitch)
  #   export EFFECT="| glitchcat --duration infinite --glitchness 30 --amount 30"
  #   ;;
  *)
    export EFFECT="| /home/badcop/.local/bin/tte --ignore-terminal-dimensions $1 | head -c -1"
    ;;
esac

start_one_effect() {
  local session="$1":0.0
  local client="$2"
  local effect="$3"
  dimensions="$(tmux -L outer display -t $session -p "#{pane_width} #{pane_height}")"
  read width height <<< "$dimensions"
  capture="$(tmux -L outer capture-pane -t $session -p -e -C)"
  echo -e "$capture" \
    | ./popup -c $client -w $width -h $height -x 0 -y 0 -B -E "$EXTRA_ARGS" &
}

if [[ -n "$all" ]]; then
  clients=(tmux -L outer list-clients -F '#{session_name} #{client_name}')
else
  clients=(tmux -L outer display -p '#{session_name} #{client_name}')
fi

while read -r session client; do
  start_one_effect "$session" "$client" "$effect"
done < <("${clients[@]}")
